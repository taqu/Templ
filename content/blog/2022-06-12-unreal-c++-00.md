---
title: "Unreal Engine C++ で開発するために 01"
date: 2022-06-12T00:00:00+09:00
archives:
    - 2022-06
categories: ["blog"]
tags: ["note", "unreal", "C++"]
draft: false
---

# はじめに
Unreal Engineで開発するにあたってC++の使い方についてある程度の知見が溜まったのでノートをとります. また, C++は"シープラスプラス"と発音します, それ以外の発音方法はありません.

# 標準ライブラリ
対象のプラットフォームによってコンパイラ（付属の標準ライブラリ）が異なるため, 深く理解している自信がないならば, Unreal Engineの用意したライブラリを使うべきです.  
特に`::malloc`に関しては, `FMemory::Malloc`と管理情報が別になってしまう可能性があるため, `FMemory::Malloc`に統一します.

Unreal Engine以外でも使うためにUnreal Engineのライブラリを一切使わないという選択をしたいことがあるかもしれませんが,  
各コンパイラ, ライブラリ, プラットフォームについて深い知識が必要です.

## print系
文字コードの問題もあるため, FStringで置き換えます. 製品コードで使うなら速度を考える必要があるかもしれませんが, 開発・デバッグ用のコードにprint系を使う理由はないはずです.


`TEXT`の存在が面倒ですが, `printf`を使うよりはずっと安全で楽でしょう.  
公式ドキュメントに説明がなくエンジン内でも使われていないため, C#のようにフォーマットを細かく指定はできない, 今後もそうならないと思われます.

```cpp
FString contenxt = TEXT("内容");
FString str = FString::Format(TEXT("リスト {0} - {1}"), {*content, 1});
```

## その他
POSIXのライブラリ関数群とSTLに関してはよく使うものは対応する機能が用意されているはずだと思って探すとよいでしょう.

- メモリ確保, メモリ操作
- 基本的数学, 幾何学
- ファイルシステム：`FPath`, `FFileHelper`
- 時刻：`FTime`
- 文字列操作
- 文字コード
- データ構造
- 暗号
- ハッシュ
- GUID
- アルゴリズム, ユーティリティ

# ソースコードの文字コード
ここでは問題は起きないと思われるため, 文字集合と符号化方式を混同して文字コードとします.

結論から"BOM付きUTF-8"一択です. この問題はコンパイラが関係しています.  
旧くはMSVCとその他のコンパイラでソースコードの文字コードを統一することが難しかったのですが, 今はコンパイラの改善でそれほど難しくありません.  
しかし, Unreal Engineが挟まることでこの問題が再燃します.

Unreal Engineにおける各コンパイラについて簡単にまとめますと,

- Clang
  - Windows系以外で使用されます.
- MSVC
  - Windows系に使用されます, XBoxもMSVCです.
  - Clangに変更することはできますが, エンジン自身に警告が残っているため実質使用できません.
    - ちなみに, "C:\Program Files"にClangがインストールされていないと認識しません.

それぞれの文字コードの扱いと, Unreal Engineの設定は次のようになっています.
- Clang
  - ソースコードの文字コードは`-finput-charset`で指定することができます, デフォルトは`UTF-8`です. BOMにも対応しています.
  - `-finput-charset`は指定されていないためデフォルトの設定です.
- MSVC
  - BOMがない場合, `cp932`として処理します. BOMがある場合は`UTF-8`として処理します.
  - コンパイルオプション`/source-charset:utf-8`を指定すると, BOMがない場合は`UTF-8`として処理します.
    - 逆に`cp932`のソースコードがあると問題が発生することがあるということです.
  - UnrealはWindowsに関しては, `/source-charset:utf-8`が指定されています.

以上から, "BOM付きUTF-8"が最も問題が起きにくいと思われます. しかし, まだ終わりません, "BOM付きUTF-8"を強制する手段が少ないのです.
例えば, テンプレート（Engine/Content/Editor/Templates）をBOM付きにしても, Unreal EngineのC++ファイル生成は"BOMを無視してロード, 特定のキーワードを置換, 保存"ですのでBOMが消えてしまいます.  
さらに最も簡単で問題が確実に起きない解決方法は, コメントも含めて"ASCII(Latin-1)以外は使わない"だと思います.  

# Unityビルド
`Unityビルド`は, C/C++のコンパイル単位を無視して, コンパイラ単位（.c/.cpp）をひとつのファイルにまとめてコンパイルする方法です.

利点は,
- インクルードが少なくなりビルド速度が速くなる可能性がある
- リンク時最適化に似た, コンパイル単位を超えた最適化が期待できる

欠点は,
- C/C++の仕様であるコンパイル単位を無視することによる問題
  - ".c/.cpp"内のプリプロセッサ定義や`無名namespace`がコンパイル単位を超えてしまう可能性がある
  - コンパイル単位を超える最適化が許されないことを利用したコードに問題がでる可能性がある
- コンパイル時のメモリ使用量が増加

どれくらいの単位でまとめるかはシステムごとに設定がありますが, 普通に運用する限りは不定だと思われます. 例えば, CMakeにはグループを明示する方法があるようです.  

他の"Unityビルド"に対応したシステムを常用していないので比較はできませんが, Unreal Engineのビルドシステムは再コンパイルすべきファイルを取りこぼす挙動が頻発します.  
特定のモジュールだけリビルドする方法として, 次のパターンを削除する方法が考えられます.

`[ProjectDirectory]/Intermediate/Build/[Platform]/UE4Editor/[Build Conciguration]/[Module Name]/*.txt`

例えば次のような感じです.

`プロジェクト名/Intermediate/Build/Win64/UE4Editor/Development/モジュール名/*.txt`

この".txt"ファイルは各コンパイル単位（.c/.cpp）が依存するファイルを保存しています.

# フォーマッタ
今日では手でフォーマットを揃えないで, clang-formatやリンタを使うことが普通と思われますが, これもUnreal EngineのDSLと相性が悪いです.  
具体的には, Slateのコードが崩れます. clang-formatの処理から除外するには次のコメントで囲みます.

```cpp
// clang-format off
// clang-format on
```

特定アルゴリズム用の固定の数値テーブルなどでも必要となるので, 覚えておくとよいでしょう.

# Coverity
Unreal EngineのDSLやマクロが静的解析ツールに指摘されることがあります. Slateのコードが指摘されると思います.

Coverityの場合は, 指摘された行の直前に次のようなコメントを入れると握りつぶすことができます ([参考](https://doclazy.wordpress.com/2011/07/14/coverity-suppressing-false-positives-with-cod/)).
```cpp
// coverity[EVENT_TAG]
/* coverity[EVENT_TAG] */
```

# C++11以上の機能
UE4の時点では, C++14以下で全プラットフォームに対応できると思います.

- リスト初期化
  - {} で初期化すると, ゼロ初期化を意図していても, コンストラクタが呼ばれます
  - UE4の場合, `FVector X {};`は未初期化になるため, `FVector X{EForceInit::ForceInitToZero;`, `FVector X = FVector::ZeroVector;`とします

