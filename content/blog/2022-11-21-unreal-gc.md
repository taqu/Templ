---
title: "Unreal Engine 5のGC対象"
date: 2022-11-21T00:00:00+09:00
archives:
    - 2022-11
categories: ["blog"]
tags: ["note", "unreal"]
draft: false
---

# はじめに

Unreal Engine 5から`TObjectPtr`が実装され, ようやく普通のGCのようになりました. 
動作の確証を得るため実際にコードを書いて検証します.

複雑なオブジェクト生成や, ロード, レベル遷移は試してませんが, 次のようなクラスで試してみました.

<details>
<summary>GCTest.h</summary>

```cpp
#pragma once

#include "CoreMinimal.h"
#include "GameFramework/Actor.h"
#include "EmptyObject.h"
#include "GCTEst.generated.h"

UCLASS()
class COLLECTION_API AGCTest : public AActor
{
	GENERATED_BODY()

public:
	AGCTest();

protected:
	virtual void BeginPlay() override;
	virtual void EndPlay(const EEndPlayReason::Type EndPlayReason) override;

public:
	virtual void Tick(float DeltaTime) override;

	UFUNCTION(BlueprintCallable, Category = "GC")
    static void ForceGC();
private:
    class Proxy
    {
    public:
        TObjectPtr<UEmptyObject> ObjectPtr_;
    };

	UObject* Raw_;
	TObjectPtr<UEmptyObject> ObjectPtr_;
	TUniquePtr<Proxy> Proxy_;
	TArray<TObjectPtr<UEmptyObject>> ObjectPtrArray_;
	TArray<Proxy> ProxyArray_;
};
```
</details>

<details>
<summary>GCTest.cpp</summary>

```cpp
#include "GCTEst.h"
#include "Singleton.h"

AGCTest::AGCTest()
{
	PrimaryActorTick.bCanEverTick = true;

}

void AGCTest::BeginPlay()
{
	Super::BeginPlay();
    Raw_ = NewObject<UEmptyObject>();
    Raw_->RemoveFromRoot();

    ObjectPtr_ = NewObject<UEmptyObject>();
    ObjectPtr_->RemoveFromRoot();

    Proxy_ = MakeUnique<Proxy>();
    Proxy_->ObjectPtr_ = NewObject<UEmptyObject>();
    Proxy_->ObjectPtr_->RemoveFromRoot();

    ObjectPtrArray_.Add(NewObject<UEmptyObject>());
    ObjectPtrArray_[0]->RemoveFromRoot();

    ProxyArray_.Add({NewObject<UEmptyObject>()});
    ProxyArray_[0].ObjectPtr_->RemoveFromRoot();

    Singleton::Initialize();
}

void AGCTest::EndPlay(const EEndPlayReason::Type EndPlayReason)
{
    Super::EndPlay(EndPlayReason);
    Singleton::Terminate();
}

void AGCTest::Tick(float DeltaTime)
{
	Super::Tick(DeltaTime);

    if (!IsValid(Raw_)) {
        UE_LOG(LogTemp, Display, TEXT("Raw is null"));
    }
    if (!ObjectPtr_) {
        UE_LOG(LogTemp, Display, TEXT("ObjectPtr is null"));
    }
    if (!Proxy_->ObjectPtr_) {
        UE_LOG(LogTemp, Display, TEXT("Proxy is null"));
    }

    if (!ObjectPtrArray_[0]) {
        UE_LOG(LogTemp, Display, TEXT("ObjectPtrArray is null"));
    }

    if(!ProxyArray_[0].ObjectPtr_) {
        UE_LOG(LogTemp, Display, TEXT("ProxyArray is null"));
    }
    Singleton::GetInstance().Update();
}

void AGCTest::ForceGC()
{
    GEngine->ForceGarbageCollection(true);
}
```
</details>

<details>
<summary>Singleton.h</summary>

```cpp
#pragma once

#include "CoreMinimal.h"
#include "EmptyObject.h"

/**
 * 
 */
class COLLECTION_API Singleton
{
public:
    static void Initialize();
    static void Terminate();
    static Singleton& GetInstance();

    void Update();
private:
	Singleton();
	~Singleton();

    static Singleton* Instance_;

    class Proxy
    {
    public:
        TObjectPtr<UEmptyObject> ObjectPtr_;
    };

	UObject* Raw_;
	TObjectPtr<UEmptyObject> ObjectPtr_;
	TUniquePtr<Proxy> Proxy_;
	TArray<TObjectPtr<UEmptyObject>> ObjectPtrArray_;
	TArray<Proxy> ProxyArray_;
};

```
</details>

<details>
<summary>Singleton.cpp</summary>

```cpp
#include "Singleton.h"

Singleton* Singleton::Instance_ = nullptr;

void Singleton::Initialize()
{
    if (nullptr != Instance_) {
        return;
    }
    Instance_ = new Singleton;
}

void Singleton::Terminate()
{
    if (nullptr == Instance_) {
        return;
    }
    delete Instance_;
    Instance_ = nullptr;
}

Singleton& Singleton::GetInstance()
{
    return *Instance_;
}

Singleton::Singleton()
{
    Raw_ = NewObject<UEmptyObject>();
    Raw_->RemoveFromRoot();

    ObjectPtr_ = NewObject<UEmptyObject>();
    ObjectPtr_->RemoveFromRoot();

    Proxy_ = MakeUnique<Proxy>();
    Proxy_->ObjectPtr_ = NewObject<UEmptyObject>();
    Proxy_->ObjectPtr_->RemoveFromRoot();

    ObjectPtrArray_.Add(NewObject<UEmptyObject>());
    ObjectPtrArray_[0]->RemoveFromRoot();

    ProxyArray_.Add({NewObject<UEmptyObject>()});
    ProxyArray_[0].ObjectPtr_->RemoveFromRoot();}

Singleton::~Singleton()
{
}

void Singleton::Update()
{
    if (!IsValid(Raw_)) {
        UE_LOG(LogTemp, Display, TEXT("Singleton: Raw is null"));
    }
    if (!ObjectPtr_) {
        UE_LOG(LogTemp, Display, TEXT("Singleton: ObjectPtr is null"));
    }
    if (!Proxy_->ObjectPtr_) {
        UE_LOG(LogTemp, Display, TEXT("Singleton: Proxy is null"));
    }

    if (!ObjectPtrArray_[0]) {
        UE_LOG(LogTemp, Display, TEXT("Singleton: ObjectPtrArray is null"));
    }

    if(!ProxyArray_[0].ObjectPtr_) {
        UE_LOG(LogTemp, Display, TEXT("Singleton: ProxyArray is null"));
    }
}
```
</details>

# まとめ

`PROPERTY`や`AddToRoot`は`TObjectPtr`に置き換えてしまっていいと思います.
